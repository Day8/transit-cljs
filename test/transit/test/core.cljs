(ns transit.test.core
  (:require [transit.core :as t]))

(enable-console-print!)

(def r (t/reader :json))
(def w (t/writer :json))

(println "testing basic transit write")
(assert (= (. w (write 1)) "{\"~#'\":1}"))
(assert (= (. w (write (js/Date. 1399471321791))) "{\"~#'\":\"~t2014-05-07T14:02:01.791Z\"}"))
(assert (= (. w (write {:foo "bar"})) "{\"~:foo\":\"bar\"}"))
(assert (= (. w (write [1 2 3])) "[1,2,3]"))
(assert (= (. w (write #{1 2 3})) "{\"~#set\":[1,2,3]}"))
(assert (= (. w (write '(1 2 3))) "{\"~#list\":[1,2,3]}"))
(assert (= (. w (write (reverse [1 2 3]))) "{\"~#list\":[3,2,1]}"))
(assert (= (. w (write (range 3))) "{\"~#list\":[0,1,2]}"))
(assert (= (. w (write (take 3 (repeat true)))) "{\"~#list\":[true,true,true]}"))
(assert (= (. w (write #js [1 2 3])) "[1,2,3]"))
(assert (= (. w (write #js {"foo" "bar"})) "{\"foo\":\"bar\"}"))

(println "testing basic transit read")
(assert (= (. r (read "{\"~#'\":1}")) 1))
(assert (= (. r (read "{\"~:foo\":\"bar\"}")) {:foo "bar"}))
(assert (= (. r (read "[1,2,3]")) [1 2 3]))
(assert (= (. r (read "{\"~#set\":[1,2,3]}")) #{1 2 3}))
(assert (= (. r (read "{\"~#list\":[1,2,3]}")) '(1 2 3)))
(assert (= (.valueOf (. r (read "{\"~#'\":\"~t2014-05-07T14:02:01.791Z\"}")))
           (.valueOf (js/Date. 1399471321791))))

(defn roundtrip [s]
  (. w (write (. r (read s)))))

(println "testing round tripping")
(assert (= (roundtrip "[\"~:foo\",\"~:bar\",{\"^\\\"\":[1,2]}]")
                      "[\"~:foo\",\"~:bar\",{\"^\\\"\":[1,2]}]"))
(assert (= (roundtrip "{\"~#point\":[1,2]}")
                      "{\"~#point\":[1,2]}"))
(assert (= (roundtrip "{\"foo\":\"~xfoo\"}")
                      "{\"foo\":\"~xfoo\"}"))
(assert (= (roundtrip "{\"~/t\":null}")
                      "{\"~/t\":null}"))
(assert (= (roundtrip "{\"~/f\":null}")
                      "{\"~/f\":null}"))
(assert (= (roundtrip "{\"~#'\":\"~f-1.1E-1\"}")
                      "{\"~#'\":\"~f-1.1E-1\"}"))
(assert (= (roundtrip "{\"~#'\":\"~f-1.10E-1\"}")
                      "{\"~#'\":\"~f-1.10E-1\"}"))
(assert (= (roundtrip "{\"~#set\":[{\"~#ratio\":[\"~i4953778853208128465\",\"~i636801457410081246\"]},{\"^\\\"\":[\"~i-8516423834113052903\",\"~i5889347882583416451\"]}]}")
                      "{\"~#set\":[{\"~#ratio\":[\"~i4953778853208128465\",\"~i636801457410081246\"]},{\"^\\\"\":[\"~i-8516423834113052903\",\"~i5889347882583416451\"]}]}"))
(assert (= (roundtrip "[{\"aaaa\":1,\"bbbb\":2},{\"^!\":3,\"^\\\"\":4},{\"^!\":5,\"^\\\"\":6}]")
                      "[{\"aaaa\":1,\"bbbb\":2},{\"^!\":3,\"^\\\"\":4},{\"^!\":5,\"^\\\"\":6}]"))
(assert (= (roundtrip "{\"~#'\":\"~i8987676543234565432178765987645654323456554331234566789\"}")
           "{\"~#'\":\"~i8987676543234565432178765987645654323456554331234566789\"}"))

(println "ok")
